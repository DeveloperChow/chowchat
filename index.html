<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#000000" />
  <title>Chowchat</title>

  <style>
    :root { --bg:#000; --panel:#0b0b0b; --line:#1b1b1b; --text:#fff; --muted:#9aa0a6; --snap:#fffc00; --blue:#00b2ff; --red:#ff2a2a; }
    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
    html,body{height:100%; margin:0; background:var(--bg); color:var(--text); font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial; overscroll-behavior:none;}
    body{ -webkit-user-select:none; user-select:none; -webkit-touch-callout:none; }
    button,input{ font:inherit; }
    #app{height:100%; display:flex; flex-direction:column; padding-top:env(safe-area-inset-top); padding-bottom:env(safe-area-inset-bottom);}
    .hidden{display:none!important;}

    /* FIX iOS input zoom + weird taps */
    input, textarea { font-size:16px; }
    button, .iconbtn, .navbtn, .row, .tool { touch-action:manipulation; }

    .topbar{height:52px; display:flex; align-items:center; justify-content:space-between; padding:0 12px; border-bottom:1px solid var(--line); background:rgba(0,0,0,.85); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px);}
    .topbar .left,.topbar .right{display:flex; align-items:center; gap:10px;}
    .pill{width:34px; height:34px; border-radius:50%; background:#222; display:grid; place-items:center; font-weight:900; overflow:hidden;}
    .pill img{width:100%; height:100%; object-fit:cover;}
    .iconbtn{position:relative; width:34px;height:34px;border-radius:10px;background:#111;border:1px solid #222;color:#fff;display:grid;place-items:center;font-size:16px; cursor:pointer;}
    .iconbtn:active{transform:scale(.98);}
    .badge{position:absolute; top:-6px; right:-6px; min-width:18px; height:18px; padding:0 5px; border-radius:999px; background:var(--red); color:#fff; font-size:11px; display:grid; place-items:center; border:2px solid #000;}
    .title{font-weight:900; letter-spacing:.2px; display:flex; align-items:center; gap:8px;}
    .typingDot{width:10px;height:10px;border-radius:50%; background:var(--blue); animation:pulse 1.1s infinite ease-in-out;}
    @keyframes pulse { 0%{transform:scale(.6);opacity:.35} 50%{transform:scale(1);opacity:1} 100%{transform:scale(.6);opacity:.35} }

    .chips{display:flex; gap:8px; padding:10px 12px; overflow:auto; border-bottom:1px solid var(--line);}
    .chip{padding:7px 12px; border-radius:18px; background:#101010; border:1px solid #222; color:#cfcfcf; font-size:13px; white-space:nowrap;}
    .chip.active{background:#1a1a1a; border-color:#333; color:#fff;}

    .screenWrap{flex:1; overflow:hidden; position:relative;}
    .screens{height:100%; display:flex; width:300%; transform:translateX(-100%); transition:transform .22s ease;}
    .screen{width:100%; height:100%; overflow:auto; background:var(--bg); -webkit-overflow-scrolling:touch;}

    /* Camera */
    .screen.camera{position:relative; background:#000;}
    #camVideo{position:absolute; inset:0; width:100%; height:100%; object-fit:cover; background:#000;}
    .cameraTools{position:absolute; right:10px; top:80px; display:flex; flex-direction:column; gap:10px; pointer-events:auto;}
    .tool{width:38px;height:38px;border-radius:12px;background:#111;border:1px solid #222; display:grid; place-items:center; color:#fff; opacity:.95; cursor:pointer;}
    .tool:active{transform:scale(.98);}
    .camBottom{position:absolute; left:0; right:0; bottom:66px; display:flex; justify-content:center; gap:12px; pointer-events:auto;}
    .shutter{width:76px;height:76px;border-radius:50%; border:6px solid #fff; background:transparent; cursor:pointer;}
    .shutter.rec{border-color:var(--red);}
    .snapBtn{padding:0 12px; height:44px; border-radius:16px; border:1px solid #222; background:var(--snap); color:#000; font-weight:900; cursor:pointer;}
    .snapBtn:active{transform:scale(.98);}
    .camHint{position:absolute; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.65); z-index:5;}
    .camHint.on{display:flex;}
    .camHint .box{width:min(360px,92vw); border:1px solid #222; background:#070707; border-radius:18px; padding:14px;}
    .camHint .box .h{font-weight:900; margin-bottom:6px;}
    .camHint .box .p{color:#bdbdbd; font-size:13px; line-height:1.35;}
    .camHint .box .b{margin-top:10px; width:100%; padding:12px; border-radius:12px; border:1px solid #222; background:var(--snap); color:#000; font-weight:900;}

    /* Chats list */
    .chatList{padding:6px 0;}
    .row{display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid #111; cursor:pointer;}
    .row:active{background:#070707;}
    .row .who{display:flex; align-items:center; gap:10px; min-width:0;}
    .avatar{width:44px;height:44px;border-radius:50%; background:#222; display:grid; place-items:center; font-weight:900; overflow:hidden; position:relative;}
    .avatar img{width:100%; height:100%; object-fit:cover;}
    .onlineDot{position:absolute; right:2px; bottom:2px; width:10px; height:10px; border-radius:50%; background:var(--blue); border:2px solid #000; display:none;}
    .onlineDot.on{display:block;}
    .meta{min-width:0;}
    .name{font-weight:900; font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:220px;}
    .sub{color:var(--muted); font-size:12.5px; margin-top:3px;}
    .rightIcons{display:flex; gap:8px;}
    .tiny{width:30px;height:30px;border-radius:10px;background:#0f0f0f;border:1px solid #222; display:grid; place-items:center; color:#fff; font-size:14px;}

    /* Bottom nav */
    .nav{height:58px; border-top:1px solid var(--line); display:flex; justify-content:space-around; align-items:center; background:rgba(0,0,0,.92); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px);}
    .navbtn{width:54px;height:44px;border-radius:18px; display:grid; place-items:center; color:#bbb; border:1px solid transparent; cursor:pointer;}
    .navbtn:active{transform:scale(.98);}
    .navbtn.active{color:#000; background:var(--snap); border-color:#d8d100;}
    .navbtn.cam{width:70px;height:48px; border-radius:22px; background:#111; border:1px solid #222; color:#fff;}
    .navbtn.cam.active{background:var(--snap); color:#000; border-color:#d8d100;}

    /* Auth */
    .auth{height:100%; display:flex; align-items:center; justify-content:center; padding:18px;}
    .card{width:100%; max-width:420px; border:1px solid #222; background:#070707; border-radius:18px; padding:16px;}
    .logo{font-weight:1000; font-size:34px; letter-spacing:.2px; text-align:center; margin:6px 0 2px;}
    .tag{color:#cfcfcf; text-align:center; font-size:13px; margin-bottom:10px;}
    .card h2{margin:0 0 10px; font-size:18px;}
    .in{width:100%; padding:12px 12px; margin:8px 0; border-radius:12px; border:1px solid #222; background:#0d0d0d; color:#fff; }
    .btn{width:100%; padding:12px; margin-top:10px; border-radius:12px; border:1px solid #222; background:#141414; color:#fff; font-weight:900; cursor:pointer;}
    .btn:active{transform:scale(.99);}
    .btn.snap{background:var(--snap); color:#000; border-color:#d8d100;}
    .small{color:var(--muted); font-size:12px; margin-top:10px; line-height:1.4;}

    /* Chat */
    .chatPanel{height:100%; display:flex; flex-direction:column;}
    .msgs{flex:1; overflow:auto; padding:12px; display:flex; flex-direction:column; gap:8px; background-size:cover; background-position:center; background-repeat:no-repeat; -webkit-overflow-scrolling:touch;}
    .bubble{max-width:78%; padding:10px 12px; border-radius:16px; border:1px solid #222; background:rgba(15,15,15,.92); backdrop-filter:blur(6px); -webkit-backdrop-filter:blur(6px); position:relative;}
    .bubble.me{align-self:flex-end; background:rgba(26,26,26,.92); border-color:#2a2a2a;}
    .bubble img{max-width:100%; border-radius:14px; display:block;}
    .bubble audio, .bubble video{width:100%; border-radius:14px; background:#000;}
    .bubble .t{font-size:14px; white-space:pre-wrap; word-break:break-word;}
    .bubble .s{margin-top:3px; font-size:11px; color:var(--muted);}
    .replyBar{margin:-2px 0 8px; padding:8px 10px; border-radius:14px; border:1px solid #222; background:#0b0b0b; color:#ddd; font-size:12px; display:none;}
    .replyBar.on{display:flex; justify-content:space-between; gap:10px; align-items:center;}
    .replyBar b{color:#fff;}
    .replyBar button{border-radius:12px; border:1px solid #222; background:#111; color:#fff; padding:6px 10px; font-weight:900; cursor:pointer;}
    .replyBar button:active{transform:scale(.98);}

    .quote{border-left:3px solid var(--blue); padding-left:8px; margin-bottom:6px; color:#cfcfcf; font-size:12px;}
    .send{display:flex; gap:8px; padding:10px 10px calc(10px + env(safe-area-inset-bottom)); border-top:1px solid #111; background:#060606; align-items:center;}
    .send input{flex:1; padding:12px; border-radius:16px; border:1px solid #222; background:#0d0d0d; color:#fff;}
    .send button{padding:0 14px; height:44px; border-radius:16px; border:1px solid #222; background:var(--snap); color:#000; font-weight:900; cursor:pointer;}
    .send button:active{transform:scale(.98);}
    .miniBtn{padding:0 10px; height:34px; border-radius:14px; border:1px solid #222; background:#111; color:#fff; font-weight:900; cursor:pointer;}
    .miniBtn:active{transform:scale(.98);}
    .micBtn{width:44px; height:44px; border-radius:16px; border:1px solid #222; background:#111; color:#fff; display:grid; place-items:center; font-weight:900; cursor:pointer;}
    .micBtn.rec{background:rgba(255,42,42,.18); border-color:rgba(255,42,42,.45);}
    .camChatBtn{width:44px; height:44px; border-radius:16px; border:1px solid #222; background:#111; color:#fff; display:grid; place-items:center; cursor:pointer;}
    .camChatBtn:active,.micBtn:active{transform:scale(.98);}

    /* Sheets */
    .sheet{position:fixed; inset:0; background:rgba(0,0,0,.65); display:none; z-index:60;}
    .sheet.on{display:block;}
    .sheetCard{position:absolute; left:10px; right:10px; bottom:10px; border-radius:18px; background:#070707; border:1px solid #222; padding:12px;}
    .sheetTitle{font-weight:900; margin:0 0 8px;}
    .sheetRow{display:flex; gap:10px; margin-top:10px;}
    .sheetRow input{flex:1;}
    .list{max-height:240px; overflow:auto; border:1px solid #222; border-radius:14px; background:#050505; -webkit-overflow-scrolling:touch;}
    .li{padding:10px 12px; border-bottom:1px solid #111; display:flex; justify-content:space-between; gap:10px; align-items:center;}
    .li:last-child{border-bottom:none;}
    .li .left{min-width:0;}
    .li .t{font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:220px;}
    .li .d{color:var(--muted); font-size:12px; margin-top:2px;}
    .li button{border-radius:12px; border:1px solid #222; background:#111; color:#fff; padding:8px 10px; font-weight:900; cursor:pointer;}
    .li button:active{transform:scale(.98);}
    .li button.snap{background:var(--snap); color:#000; border-color:#d8d100;}

    /* Cropper */
    #cropperSheet .sheetCard{padding:0; overflow:hidden;}
    .cropHead{display:flex; justify-content:space-between; align-items:center; padding:12px; border-bottom:1px solid #111;}
    .cropHead .t{font-weight:900;}
    .cropBody{padding:12px;}
    .cropBox{position:relative; width:100%; aspect-ratio:1/1; border-radius:18px; overflow:hidden; border:1px solid #222; background:#000;}
    #cropCanvas{width:100%; height:100%; display:block; touch-action:none;}
    .cropControls{display:flex; gap:10px; align-items:center; margin-top:12px;}
    .range{width:100%;}
    .pillStat{display:inline-flex; gap:8px; align-items:center; padding:8px 10px; border:1px solid #222; border-radius:999px; background:#0b0b0b; color:#ddd; font-size:12px; white-space:nowrap;}
    .pillStat b{color:#fff;}
  </style>
</head>

<body>
<div id="app">
  <!-- AUTH -->
  <div id="authScreen" class="auth">
    <div class="card">
      <div class="logo">Chowchat</div>
      <div class="tag">Camera-first chat</div>

      <h2>Sign in</h2>
      <input id="loginUser" class="in" placeholder="Username" autocapitalize="none" autocomplete="username" />
      <input id="pass" class="in" placeholder="Password" type="password" autocomplete="current-password" />
      <input id="signupUser" class="in" placeholder="Username (signup only, no spaces)" autocapitalize="none" />
      <button id="btnLogin" class="btn snap">Login</button>
      <button id="btnSignup" class="btn">Create account</button>
      <div class="small" style="margin-top:10px;">do not use any password you use on other apps!</div>
      <div class="small" id="authMsg"></div>
    </div>
  </div>

  <!-- APP -->
  <div id="mainApp" class="hidden" style="height:100%; display:flex; flex-direction:column;">
    <div class="topbar">
      <div class="left">
        <div class="pill" id="mePill">I</div>
        <div class="iconbtn" id="btnSearch">üîé</div>
      </div>

      <div class="title" id="topTitle">
        <span id="topTitleText">Camera</span>
      </div>

      <div class="right">
        <div class="iconbtn">üîî</div>
        <div class="iconbtn" id="btnAdd">‚ûï<span id="addBadge" class="badge hidden">0</span></div>
        <div class="iconbtn" id="btnMenu">‚öôÔ∏è</div>
      </div>
    </div>

    <div id="chipsBar" class="chips hidden">
      <div class="chip active">All</div>
      <div class="chip">Unread</div>
      <div class="chip">Streaks</div>
      <div class="chip">Stories</div>
      <div class="chip">Calls</div>
      <div class="chip">Groups</div>
    </div>

    <div class="screenWrap" id="swipeRoot">
      <div class="screens" id="screens">

        <!-- CHATS -->
        <div class="screen" id="screenChats">
          <div class="chatList" id="chatList"></div>
        </div>

        <!-- CAMERA -->
        <div class="screen camera" id="screenCamera">
          <video id="camVideo" autoplay playsinline muted></video>

          <div class="camHint on" id="camHint">
            <div class="box">
              <div class="h">Enable Camera</div>
              <div class="p">You must be on HTTPS and tap Enable. If it stays black, allow camera permission in Safari settings</div>
              <button class="b" id="btnEnableCam">Enable</button>
            </div>
          </div>

          <div class="cameraTools" id="cameraTools">
            <div class="tool" id="btnFlipCam">üîÅ</div>
            <div class="tool" id="btnCamOnOff">‚èª</div>
            <div class="tool" id="btnRecVid" title="Hold to record">üé•</div>
          </div>

          <div class="camBottom">
            <button class="shutter" id="btnShutter" aria-label="Shutter"></button>
            <button class="snapBtn" id="btnSendSnap" aria-label="Send Snap">Send Snap</button>
          </div>
        </div>

        <!-- STORIES -->
        <div class="screen" id="screenStories">
          <div style="padding:18px; color:#bbb;">
            <div style="font-weight:900; color:#fff;">Stories</div>
            <div style="margin-top:6px;">Placeholder</div>
          </div>
        </div>

      </div>
    </div>

    <div class="nav">
      <div class="navbtn" id="navChats">üí¨</div>
      <div class="navbtn cam active" id="navCam">‚¨§</div>
      <div class="navbtn" id="navStories">‚ñ∂Ô∏è</div>
      <div class="navbtn" id="navProfile">üë§</div>
      <div class="navbtn" id="navLogout">‚éã</div>
    </div>
  </div>
</div>

<!-- CHAT MODAL -->
<div id="chatModal" class="hidden" style="position:fixed; inset:0; background:#000; z-index:55; display:flex; flex-direction:column;">
  <div class="topbar">
    <div class="left" style="gap:8px;">
      <div class="iconbtn" id="btnBack">‚Üê</div>
      <div class="pill" id="chatPill" style="width:34px;height:34px;">C</div>
      <div class="title" style="cursor:pointer;" id="chatHeaderTap">
        <span id="chatTitle">Chat</span>
        <span id="typingIndicator" class="hidden typingDot"></span>
        <span id="onlineIndicator" class="hidden typingDot" style="animation:none; opacity:1; transform:none;"></span>
      </div>
    </div>
    <div class="right">
      <button class="miniBtn" id="btnWallpaper">Wallpaper</button>
      <button class="miniBtn" id="btnNick">Name</button>
      <div class="iconbtn" id="btnSignOutMini">‚éã</div>
    </div>
  </div>

  <div class="chatPanel">
    <div class="msgs" id="msgs"></div>

    <div class="send" style="display:block; padding:10px 10px calc(10px + env(safe-area-inset-bottom));">
      <div id="replyBar" class="replyBar">
        <div><b>Replying</b> <span id="replyText"></span></div>
        <button id="replyCancel">X</button>
      </div>

      <div style="display:flex; gap:8px; align-items:center;">
        <div class="camChatBtn" id="btnChatSnap" title="Send snap">üì∑</div>
        <input id="msgInput" placeholder="Send a chat" />
        <div class="micBtn" id="btnMic" title="Hold to voice">üéôÔ∏è</div>
        <button id="sendBtn">Send</button>
      </div>
    </div>
  </div>
</div>

<!-- ADD FRIENDS / REQUESTS -->
<div id="addSheet" class="sheet">
  <div class="sheetCard">
    <div class="sheetTitle">Add Friends</div>
    <div class="sheetRow">
      <input id="findUser" class="in" placeholder="Search username" autocapitalize="none" />
      <button id="btnSendReq" class="btn snap" style="width:auto; margin:0; padding:10px 12px;">Add</button>
    </div>

    <div style="margin-top:10px; font-weight:900;">Recently Added</div>
    <div class="list" id="recentList" style="margin-top:8px;"></div>

    <div style="margin-top:12px; font-weight:900;">Added You</div>
    <div class="list" id="requestsList" style="margin-top:8px;"></div>

    <div class="sheetRow">
      <button id="btnCloseAdd" class="btn" style="margin:0;">Close</button>
      <button id="btnCreateGroup" class="btn snap" style="margin:0;">Create Group</button>
    </div>
  </div>
</div>

<!-- PROFILE -->
<div id="profileSheet" class="sheet">
  <div class="sheetCard">
    <div class="sheetTitle">Profile</div>

    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:8px;">
      <div class="pillStat">Snapscore <b id="mySnapscore">0</b></div>
      <div class="pillStat">Textscore <b id="myTextscore">0</b></div>
    </div>

    <input id="displayName" class="in" placeholder="Display name" />
    <div class="sheetRow">
      <input id="pfpFile" type="file" accept="image/*" class="in" style="padding:10px;" />
      <button id="btnCropPfp" class="btn" style="width:auto; margin:0; padding:10px 12px;">Crop</button>
      <button id="btnSaveProfile" class="btn snap" style="width:auto; margin:0; padding:10px 12px;">Save</button>
    </div>

    <div class="small" id="profileMsg"></div>

    <div class="sheetRow">
      <button id="btnCloseProfile" class="btn" style="margin:0;">Close</button>
    </div>
  </div>
</div>

<!-- SETTINGS -->
<div id="settingsSheet" class="sheet">
  <div class="sheetCard">
    <div class="sheetTitle">Settings</div>
    <input id="newPass" class="in" placeholder="New password (coming soon)" disabled />
    <div class="small">Password change needs a re-auth flow, we‚Äôll add it next</div>
    <div class="sheetRow">
      <button id="btnCloseSettings" class="btn" style="margin:0;">Close</button>
      <button id="btnLogoutNow" class="btn snap" style="margin:0;">Log out</button>
    </div>
  </div>
</div>

<!-- OTHER USER PROFILE (from chat) -->
<div id="userSheet" class="sheet">
  <div class="sheetCard">
    <div class="sheetTitle" id="userSheetTitle">User</div>
    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:8px;">
      <div class="pillStat">Snapscore <b id="userSnapscore">0</b></div>
      <div class="pillStat">Textscore <b id="userTextscore">0</b></div>
      <div class="pillStat">Streak <b id="userStreak">0</b></div>
    </div>
    <div class="small" id="userPresence">Offline</div>
    <div class="sheetRow">
      <button id="btnCloseUser" class="btn" style="margin:0;">Close</button>
    </div>
  </div>
</div>

<!-- CROPPER -->
<div id="cropperSheet" class="sheet">
  <div class="sheetCard">
    <div class="cropHead">
      <div class="t">Crop Profile Photo</div>
      <button class="miniBtn" id="btnCropClose">Close</button>
    </div>
    <div class="cropBody">
      <div class="cropBox">
        <canvas id="cropCanvas" width="800" height="800"></canvas>
      </div>
      <div class="cropControls">
        <input id="cropZoom" class="range" type="range" min="1" max="4" step="0.01" value="1" />
        <button class="btn snap" id="btnCropApply" style="width:auto; margin:0; padding:10px 12px;">Apply</button>
      </div>
      <div class="small">Drag to position, use slider to zoom, then Apply</div>
    </div>
  </div>
</div>

<input id="wallFile" type="file" accept="image/*" class="hidden" />

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getAuth, onAuthStateChanged,
    signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore,
    doc, setDoc, getDoc,
    collection, addDoc, query, where, orderBy, limit, onSnapshot, serverTimestamp, getDocs, increment
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA4iSXdKxbyvnD8yMZrl3VW73gvvgU74ik",
    authDomain: "chowchat.firebaseapp.com",
    projectId: "chowchat",
    storageBucket: "chowchat.firebasestorage.app",
    messagingSenderId: "624312959317",
    appId: "1:624312959317:web:e8ab9a416958804e832fdc"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  const $ = (id) => document.getElementById(id);

  // UI refs
  const authScreen = $("authScreen"), mainApp = $("mainApp"), authMsg = $("authMsg");
  const mePill = $("mePill");
  const screens = $("screens"), chipsBar = $("chipsBar"), topTitleText = $("topTitleText");
  const navChats = $("navChats"), navCam = $("navCam"), navStories = $("navStories"), navProfile = $("navProfile"), navLogout = $("navLogout");
  const btnAdd = $("btnAdd"), addSheet = $("addSheet");
  const chatList = $("chatList");
  const requestsList = $("requestsList");
  const chatModal = $("chatModal"), btnBack = $("btnBack"), chatTitle = $("chatTitle"),
        typingIndicator = $("typingIndicator"), onlineIndicator = $("onlineIndicator");
  const chatPill = $("chatPill"), chatHeaderTap = $("chatHeaderTap");
  const msgs = $("msgs"), msgInput = $("msgInput"), sendBtn = $("sendBtn");
  const replyBar = $("replyBar"), replyText = $("replyText"), replyCancel = $("replyCancel");
  const btnWallpaper = $("btnWallpaper"), wallFile = $("wallFile");
  const btnNick = $("btnNick");
  const profileSheet = $("profileSheet"), btnSaveProfile = $("btnSaveProfile"),
        profileMsg = $("profileMsg"), pfpFile = $("pfpFile"), displayName = $("displayName");
  const mySnapscore = $("mySnapscore"), myTextscore = $("myTextscore");
  const btnCropPfp = $("btnCropPfp");
  const userSheet = $("userSheet"), userSheetTitle = $("userSheetTitle"),
        userSnapscore = $("userSnapscore"), userTextscore = $("userTextscore"),
        userStreak = $("userStreak"), userPresence = $("userPresence"), btnCloseUser = $("btnCloseUser");
  const cropperSheet = $("cropperSheet"), cropCanvas = $("cropCanvas"),
        cropZoom = $("cropZoom"), btnCropApply = $("btnCropApply"), btnCropClose = $("btnCropClose");
  const btnChatSnap = $("btnChatSnap");
  const btnMic = $("btnMic");
  const findUser = $("findUser"), btnSendReq = $("btnSendReq"), btnCreateGroup = $("btnCreateGroup");
  const btnCloseAdd = $("btnCloseAdd"), btnCloseProfile = $("btnCloseProfile");
  const btnSignOutMini = $("btnSignOutMini");

  const settingsSheet = $("settingsSheet"), btnCloseSettings = $("btnCloseSettings"),
        btnLogoutNow = $("btnLogoutNow"), btnMenu = $("btnMenu");

  // Auth inputs
  const loginUser = $("loginUser"), signupUser = $("signupUser"), pass = $("pass");

// Camera
  const camVideo = $("camVideo"), btnFlipCam = $("btnFlipCam"),
        btnCamOnOff = $("btnCamOnOff"), btnSendSnap = $("btnSendSnap"),
        btnShutter = $("btnShutter");
  const camHint = $("camHint"), btnEnableCam = $("btnEnableCam"), btnRecVid = $("btnRecVid");
  let camStream = null;
  let facing = "user";
  let camOn = false;
  let lastSnapBlob = null;

  // Voice recording
  let micStream = null;
  let micRecorder = null;
  let micChunks = [];
  let recordingAudio = false;

  // app state
  let me = null;
  let meProfile = null;
  let screenIndex = 1; // chats=0, cam=1, stories=2
  let activeRoomId = null;
  let activeRoom = null;
  let activeRoomUnsub = null;
  let typingUnsub = null;
  let otherUserUnsub = null;
  let replyTo = null;

  // local nickname + wallpaper (per room)
  const nickKey = (roomId) => `nick_${me?.uid}_${roomId}`;
  const wallKey = (roomId) => `wall_${me?.uid}_${roomId}`;

  function toast(msg){
    const t = document.createElement("div");
    t.textContent = msg;
    t.style.cssText = "position:fixed;left:50%;top:16px;transform:translateX(-50%);background:rgba(0,0,0,.8);border:1px solid #222;color:#fff;padding:10px 12px;border-radius:12px;z-index:9999;font-weight:800;font-size:13px;max-width:92vw;text-align:center;";
    document.body.appendChild(t);
    setTimeout(()=>t.remove(), 1600);
  }

  function utcDayKey(d=new Date()){
    const y=d.getUTCFullYear();
    const m=String(d.getUTCMonth()+1).padStart(2,"0");
    const da=String(d.getUTCDate()).padStart(2,"0");
    return `${y}-${m}-${da}`;
  }
  function yesterdayKey(){
    const d=new Date();
    d.setUTCDate(d.getUTCDate()-1);
    return utcDayKey(d);
  }
  function idForPair(a,b){ return [a,b].sort().join("_"); }

  // UI: screens
  const setScreen = (i) => {
    screenIndex = Math.max(0, Math.min(2, i));
    screens.style.transform = `translateX(${-(screenIndex*100)}%)`;
    navChats.classList.toggle("active", screenIndex===0);
    navCam.classList.toggle("active", screenIndex===1);
    navStories.classList.toggle("active", screenIndex===2);

    if (screenIndex===0){
      chipsBar.classList.remove("hidden");
      topTitleText.textContent = "Chat";
    } else if (screenIndex===1){
      chipsBar.classList.add("hidden");
      topTitleText.textContent = "Camera";
    } else {
      chipsBar.classList.add("hidden");
      topTitleText.textContent = "Stories";
    }
  };

  navChats.onclick = () => setScreen(0);
  navCam.onclick = () => setScreen(1);
  navStories.onclick = () => setScreen(2);
  navProfile.onclick = () => profileSheet.classList.add("on");
  navLogout.onclick = async () => { await signOut(auth); };

  // Settings (top right ‚öôÔ∏è)
  btnMenu.onclick = () => settingsSheet.classList.add("on");
  btnCloseSettings.onclick = () => settingsSheet.classList.remove("on");
  btnLogoutNow.onclick = async () => { await signOut(auth); };

  btnCloseProfile.onclick = () => profileSheet.classList.remove("on");
  btnCloseUser.onclick = () => userSheet.classList.remove("on");
  btnCloseAdd.onclick = () => addSheet.classList.remove("on");
  chatHeaderTap.onclick = () => userSheet.classList.add("on");

  // Stop iOS double-tap zoom + reduce delayed taps
  (function(){
    let lastTouchEnd = 0;
    document.addEventListener("touchend", (e) => {
      const now = Date.now();
      if (now - lastTouchEnd <= 300) e.preventDefault();
      lastTouchEnd = now;
    }, { passive:false });
  })();

  // Swipe nav (camera-first)
  const swipeRoot = $("swipeRoot");
  let startX = 0, dx = 0, dragging = false;
  swipeRoot.addEventListener("touchstart", (e) => {
    if (!chatModal.classList.contains("hidden")) return;
    dragging = true; dx = 0; startX = e.touches[0].clientX;
    screens.style.transition = "none";
  }, {passive:true});
  swipeRoot.addEventListener("touchmove", (e) => {
    if (!dragging) return;
    dx = e.touches[0].clientX - startX;
    const pct = (dx / window.innerWidth) * 100;
    screens.style.transform = `translateX(${-(screenIndex*100) + pct}%)`;
  }, {passive:true});
  swipeRoot.addEventListener("touchend", () => {
    if (!dragging) return;
    dragging = false;
    screens.style.transition = "transform .22s ease";
    if (dx > 60) setScreen(screenIndex - 1);
    else if (dx < -60) setScreen(screenIndex + 1);
    else setScreen(screenIndex);
  });

  // ---------- AUTH (username + password, backed by Firebase Auth email/pass) ----------
  async function resolveUserByUsername(uname){
    const qy = query(collection(db,"users"), where("username","==", uname.toLowerCase()), limit(1));
    const snap = await getDocs(qy);
    if(snap.empty) return null;
    return { id: snap.docs[0].id, ...snap.docs[0].data() };
  }

  async function doLogin(){
    authMsg.textContent = "";
    const uname = loginUser.value.trim().toLowerCase();
    const pw = pass.value;
    if(!uname || !pw){ authMsg.textContent = "Enter username + password"; return; }

    const u = await resolveUserByUsername(uname);
    if(!u){ authMsg.textContent = "Username or password incorrect"; return; }

    try{
      await signInWithEmailAndPassword(auth, u.email, pw);
    }catch{
      authMsg.textContent = "Username or password incorrect";
    }
  }

  async function doSignup(){
    authMsg.textContent = "";
    const uname = signupUser.value.trim().toLowerCase();
    const pw = pass.value;
    if(!uname || /\s/.test(uname)){ authMsg.textContent = "Username required (no spaces)"; return; }
    if(!pw || pw.length < 6){ authMsg.textContent = "Password must be 6+ chars"; return; }

    const exists = await resolveUserByUsername(uname);
    if(exists){ authMsg.textContent = "Username taken"; return; }

    // fake email so Auth can work, login still uses username
    const email = `${uname}@chowchat.local`;

    try{
      const cred = await createUserWithEmailAndPassword(auth, email, pw);
      const uid = cred.user.uid;

      await setDoc(doc(db,"users",uid),{
        uid,
        email,
        username: uname,
        displayName: uname,
        photoURL: "",
        snapscore: 0,
        textscore: 0,
        online: true,
        lastActive: serverTimestamp(),
        createdAt: serverTimestamp()
      },{merge:true});

    }catch(e){
      authMsg.textContent = e.message;
    }
  }

$("btnLogin").onclick = doLogin;
$("btnSignup").onclick = doSignup;

loginUser.addEventListener("keydown", e => {
  if (e.key === "Enter") btnLogin.click();
});

pass.addEventListener("keydown", e => {
  if (e.key === "Enter") btnLogin.click();
});

signupUser.addEventListener("keydown", e => {
  if (e.key === "Enter") btnSignup.click();
});

  // Enter key should login
  loginUser.addEventListener("keydown",(e)=>{ if(e.key==="Enter") doLogin(); });
  pass.addEventListener("keydown",(e)=>{ if(e.key==="Enter") doLogin(); });

  // ---------- PRESENCE ----------
  let presenceTimer = null;
  async function setPresence(online){
    if(!me) return;
    try{ await setDoc(doc(db,"users",me.uid),{ online, lastActive: serverTimestamp() },{merge:true}); }catch{}
  }
  function startPresence(){
    if(presenceTimer) clearInterval(presenceTimer);
    setPresence(true);
    presenceTimer = setInterval(()=>setPresence(true), 25000);
    window.addEventListener("focus", ()=>setPresence(true));
    window.addEventListener("blur", ()=>setPresence(false));
    document.addEventListener("visibilitychange", ()=>{
      setPresence(document.visibilityState === "visible");
    });
  }
  function stopPresence(){
    if(presenceTimer) clearInterval(presenceTimer);
    presenceTimer = null;
    setPresence(false);
  }

  // ---------- FRIENDS / REQUESTS ----------
  btnAdd.onclick = () => addSheet.classList.add("on");

  btnSendReq.onclick = async () => {
    if(!me) return;
    const uname = findUser.value.trim().toLowerCase();
    if(!uname) return;

    const other = await resolveUserByUsername(uname);
    if(!other){ toast("User not found"); return; }
    if(other.uid === me.uid){ toast("That's you"); return; }

    const reqId = `${me.uid}_${other.uid}`;
    await setDoc(doc(db,"friendRequests",reqId),{
      id:reqId,
      from: me.uid,
      to: other.uid,
      status:"pending",
      createdAt: serverTimestamp()
    },{merge:true});

    findUser.value = "";
    toast("Request sent");
  };

  async function acceptRequest(req){
    const otherUid = req.from;
    const frId = idForPair(me.uid, otherUid);

    await setDoc(doc(db,"friendRequests",req.id),{status:"accepted", acceptedAt:serverTimestamp()},{merge:true});
    await setDoc(doc(db,"friends",frId),{id:frId, members:[me.uid,otherUid].sort(), createdAt:serverTimestamp()},{merge:true});

    const roomId = `dm_${frId}`;
    await setDoc(doc(db,"rooms",roomId),{
      id:roomId,
      type:"dm",
      members:[me.uid,otherUid],
      createdAt:serverTimestamp(),
      updatedAt:serverTimestamp(),
      lastPreview:"",
      streakCount:0,
      streakLastDay:null,
      snappedToday:{}
    },{merge:true});

    toast("Added");
  }
function listenRequests(){
    const qReq = query(
      collection(db,"friendRequests"),
      where("to","==",me.uid),
      limit(30)
    );
    onSnapshot(qReq, async (snap)=>{
      requestsList.innerHTML = "";
      const pending = snap.docs.map(d=>({ id:d.id, ...d.data() })).filter(r=>r.status==="pending");
      if(!pending.length){
        requestsList.innerHTML = `<div class="li"><div class="left"><div class="t">No requests</div><div class="d">You‚Äôre all caught up</div></div></div>`;
        return;
      }
      for(const req of pending){
        const other = await getDoc(doc(db,"users",req.from));
        const u = other.data();
        const li = document.createElement("div");
        li.className = "li";
        li.innerHTML = `
          <div class="left">
            <div class="t">${u?.displayName || u?.username || "User"}</div>
            <div class="d">@${u?.username || ""}</div>
          </div>
          <div style="display:flex;gap:8px;">
            <button class="snap">Accept</button>
          </div>
        `;
        li.querySelector("button").onclick = ()=>acceptRequest(req);
        requestsList.appendChild(li);
      }
    });
  }

        const req = d.data();
        const other = await getDoc(doc(db,"users",req.from));
        const u = other.data();

        const li = document.createElement("div");
        li.className = "li";
        li.innerHTML = `
          <div class="left">
            <div class="t">${u?.displayName || u?.username || "User"}</div>
            <div class="d">@${u?.username || ""}</div>
          </div>
          <div style="display:flex;gap:8px;">
            <button class="snap">Accept</button>
          </div>
        `;
        li.querySelector("button").onclick = ()=>acceptRequest({ id:d.id, ...req });
        requestsList.appendChild(li);
      }
      if(!snap.size) requestsList.innerHTML = `<div class="li"><div class="left"><div class="t">No requests</div><div class="d">You‚Äôre all caught up</div></div></div>`;
    });
  }

  btnCreateGroup.onclick = async ()=>{
    if(!me) return;
    const gid = `grp_${me.uid}_${Date.now()}`;
    await setDoc(doc(db,"rooms",gid),{
      id:gid, type:"group", name:"Group", owner:me.uid,
      members:[me.uid],
      createdAt:serverTimestamp(),
      updatedAt:serverTimestamp(),
      lastPreview:"",
      streakCount:0, streakLastDay:null, snappedToday:{}
    },{merge:true});
    toast("Group created");
  };

  // ---------- CHAT OPEN/CLOSE ----------
  btnBack.onclick = ()=>closeChat();
  btnSignOutMini.onclick = async ()=>{ await signOut(auth); };

  function closeChat(){
    chatModal.classList.add("hidden");
    activeRoomId = null;
    activeRoom = null;
    replyTo = null;
    replyBar.classList.remove("on");
    if(activeRoomUnsub) activeRoomUnsub();
    if(typingUnsub) typingUnsub();
    if(otherUserUnsub) otherUserUnsub();
    activeRoomUnsub = typingUnsub = otherUserUnsub = null;
    msgs.style.backgroundImage = "";
    typingIndicator.classList.add("hidden");
    onlineIndicator.classList.add("hidden");
  }

  // Wallpaper
  btnWallpaper.onclick = ()=> wallFile.click();
  wallFile.addEventListener("change", ()=>{
    if(!activeRoomId) return;
    const f = wallFile.files?.[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      const url = reader.result;
      localStorage.setItem(wallKey(activeRoomId), url);
      msgs.style.backgroundImage = `url('${url}')`;
    };
    reader.readAsDataURL(f);
  });

  // Nickname
  btnNick.onclick = ()=>{
    if(!activeRoomId) return;
    const cur = localStorage.getItem(nickKey(activeRoomId)) || "";
    const n = prompt("Custom name for this chat", cur);
    if(n === null) return;
    localStorage.setItem(nickKey(activeRoomId), n);
    chatTitle.textContent = n || (activeRoom?.title || activeRoom?.name || "Chat");
  };

  // Typing indicator
  let typingTimer = null;
  msgInput.addEventListener("input", async ()=>{
    if(!me || !activeRoomId) return;
    const myTypingRef = doc(db,"rooms",activeRoomId,"typing",me.uid);
    await setDoc(myTypingRef,{ uid:me.uid, typing:true, at:serverTimestamp() },{merge:true});
    clearTimeout(typingTimer);
    typingTimer = setTimeout(async ()=>{
      await setDoc(myTypingRef,{ typing:false },{merge:true});
    }, 900);
  });

  function listenTyping(){
    if(!activeRoomId) return;
    const qy = query(collection(db,"rooms",activeRoomId,"typing"));
    typingUnsub = onSnapshot(qy,(snap)=>{
      let otherTyping=false;
      snap.forEach(d=>{
        const t=d.data();
        if(t.uid!==me.uid && t.typing===true) otherTyping=true;
      });
      typingIndicator.classList.toggle("hidden", !otherTyping);
    });
  }

  // Reply UI
  replyCancel.onclick = ()=>{
    replyTo = null;
    replyBar.classList.remove("on");
  };

  // ---------- STREAK (snap-only) ----------
  async function updateSnapStreak(roomId, senderUid){
    const roomRef = doc(db,"rooms",roomId);
    const snap = await getDoc(roomRef);
    if(!snap.exists()) return;

    const room = snap.data();
    const members = Array.isArray(room.members)?room.members:[];
    const today = utcDayKey();
    const yKey = yesterdayKey();

    let streakCount = room.streakCount || 0;
    let streakLastDay = room.streakLastDay || null;
    let snappedToday = room.snappedToday || {};

    snappedToday = { ...(snappedToday||{}), [senderUid]: true };
    const allDone = members.length>=2 && members.every(uid=>snappedToday[uid]===true);

    if(allDone){
      if(streakLastDay !== today){
        streakCount = (streakLastDay === yKey) ? (streakCount+1) : 1;
        streakLastDay = today;
      }
      const reset = {};
      members.forEach(uid=>reset[uid]=false);
      snappedToday = reset;
    }

    await setDoc(roomRef,{ streakCount, streakLastDay, snappedToday, updatedAt:serverTimestamp() },{merge:true});
    userStreak.textContent = streakCount || 0;
  }

  // ---------- RENDER MSGS ----------
  function renderMsg(m){
    const div = document.createElement("div");
    div.className = "bubble" + (m.uid===me.uid ? " me" : "");

    // swipe-to-reply (right swipe)
    let sx=0, swiping=false;
    div.addEventListener("touchstart",(e)=>{
      sx = e.touches[0].clientX; swiping=true;
    },{passive:true});
    div.addEventListener("touchmove",(e)=>{
      if(!swiping) return;
      const dx = e.touches[0].clientX - sx;
      if(dx > 60){
        swiping=false;
        replyTo = { mid:m.id || null, text:(m.text || (m.type==="snap"?"Snap":m.type==="audio"?"Voice":"Media")), from:(m.fromName||"") };
        replyText.textContent = `: ${replyTo.text.slice(0,32)}${replyTo.text.length>32?"‚Ä¶":""}`;
        replyBar.classList.add("on");
      }
    },{passive:true});
    div.addEventListener("touchend",()=>{ swiping=false; });

    let head = "";
    if(m.reply?.text){
      head = `<div class="quote">${(m.reply.from||"").slice(0,18)}: ${String(m.reply.text).slice(0,60)}${String(m.reply.text).length>60?"‚Ä¶":""}</div>`;
    }

    if(m.type==="snap" && m.mediaURL){
      div.innerHTML = `${head}<img /><div class="s"></div>`;
      div.querySelector("img").src = m.mediaURL;
      div.querySelector(".s").textContent = m.fromName || "";
      return div;
    }
    if(m.type==="audio" && m.mediaURL){
      div.innerHTML = `${head}<audio controls></audio><div class="s"></div>`;
      div.querySelector("audio").src = m.mediaURL;
      div.querySelector(".s").textContent = m.fromName || "";
      return div;
    }

    div.innerHTML = `${head}<div class="t"></div><div class="s"></div>`;
    div.querySelector(".t").textContent = m.text || "";
    div.querySelector(".s").textContent = m.fromName || "";
    return div;
  }

  async function openRoom(roomId, roomData){
    activeRoomId = roomId;
    activeRoom = roomData;

    chatModal.classList.remove("hidden");
    const nick = localStorage.getItem(nickKey(roomId)) || "";
    chatTitle.textContent = nick || roomData.title || roomData.name || "Chat";

    const wall = localStorage.getItem(wallKey(roomId));
    msgs.style.backgroundImage = wall ? `url('${wall}')` : "";

    if(activeRoomUnsub) activeRoomUnsub();
    if(typingUnsub) typingUnsub();
    if(otherUserUnsub) otherUserUnsub();
    listenTyping();

    // show streak count on user sheet when DM
    userStreak.textContent = roomData.streakCount || 0;

    await setupChatHeaderPresence(roomData);

    const qMsgs = query(collection(db,"rooms",roomId,"messages"), orderBy("createdAt","desc"), limit(120));
    activeRoomUnsub = onSnapshot(qMsgs,(snap)=>{
      const arr=[];
      snap.forEach(d=>arr.push({ id:d.id, ...d.data() }));
      arr.reverse();
      msgs.innerHTML="";
      for(const m of arr) msgs.appendChild(renderMsg(m));
      msgs.scrollTop = msgs.scrollHeight;
    });
  }

  // ---------- SEND TEXT ----------
  async function sendText(){
    if(!me || !activeRoomId) return;
    const text = msgInput.value.trim();
    if(!text) return;

    const payload = {
      type:"text",
      text,
      uid: me.uid,
      fromName: meProfile?.displayName || meProfile?.username || "",
      createdAt: serverTimestamp()
    };

    if(replyTo){
      payload.reply = { mid: replyTo.mid || null, text: replyTo.text || "", from: replyTo.from || "" };
      replyTo = null;
      replyBar.classList.remove("on");
    }

    msgInput.value = "";

    await addDoc(collection(db,"rooms",activeRoomId,"messages"), payload);

    await setDoc(doc(db,"rooms",activeRoomId),{ lastPreview:text, updatedAt:serverTimestamp() },{merge:true});
    await setDoc(doc(db,"users",me.uid),{ textscore: increment(1) },{merge:true});
  }
  sendBtn.onclick = sendText;
  msgInput.addEventListener("keydown",(e)=>{ if(e.key==="Enter") sendText(); });

  // ---------- CAMERA (best-effort iPhone Safari) ----------
  async function startCamera(){
    try{
      if(!navigator.mediaDevices?.getUserMedia){
        camHint.classList.add("on"); toast("Camera not supported"); return;
      }
      if(camStream){ camStream.getTracks().forEach(t=>t.stop()); camStream=null; }
      camStream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:facing }, audio:false });
      camVideo.srcObject = camStream;
      camOn = true;
      camHint.classList.remove("on");
      await camVideo.play().catch(()=>{});
    }catch{
      camOn=false;
      camHint.classList.add("on");
      toast("Allow camera permission");
    }
  }
  async function stopCamera(){
    if(camStream){ camStream.getTracks().forEach(t=>t.stop()); camStream=null; }
    camOn=false;
  }

  btnEnableCam.onclick = ()=>startCamera();
  btnFlipCam.onclick = async ()=>{
    facing = (facing==="user") ? "environment" : "user";
    if(camOn) await startCamera();
  };
  btnCamOnOff.onclick = async ()=>{
    if(camOn){ await stopCamera(); camHint.classList.add("on"); }
    else await startCamera();
  };

  // Capture snap
  btnShutter.addEventListener("click", async ()=>{
    if(!camOn || !camVideo.videoWidth){ toast("Camera not ready"); return; }
    const canvas = document.createElement("canvas");
    canvas.width = camVideo.videoWidth;
    canvas.height = camVideo.videoHeight;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(camVideo,0,0,canvas.width,canvas.height);
    lastSnapBlob = await new Promise(res=>canvas.toBlob(res,"image/jpeg",0.9));
    toast("Snap captured");
  });

  async function uploadSnap(blob){
    const path = `snaps/${me.uid}/${Date.now()}.jpg`;
    const r = ref(storage,path);
    await uploadBytes(r,blob,{contentType:"image/jpeg"});
    return await getDownloadURL(r);
  }

  async function pickRoomToSend(){
    if(activeRoomId) return activeRoomId;
    const qRooms = query(collection(db,"rooms"), where("members","array-contains",me.uid), orderBy("updatedAt","desc"), limit(1));
    const snap = await getDocs(qRooms);
    if(snap.empty) return null;
    return snap.docs[0].id;
  }

  btnSendSnap.onclick = async ()=>{
    if(!lastSnapBlob){ toast("Take a snap first"); return; }
    const roomId = await pickRoomToSend();
    if(!roomId){ toast("No chat to send to"); return; }

    const url = await uploadSnap(lastSnapBlob);

    await addDoc(collection(db,"rooms",roomId,"messages"),{
      type:"snap",
      mediaURL:url,
      uid:me.uid,
      fromName: meProfile?.displayName || meProfile?.username || "",
      createdAt:serverTimestamp()
    });

    await updateSnapStreak(roomId, me.uid);

    await setDoc(doc(db,"rooms",roomId),{ lastPreview:"Snap", updatedAt:serverTimestamp() },{merge:true});
    await setDoc(doc(db,"users",me.uid),{ snapscore: increment(1) },{merge:true});

    lastSnapBlob=null;
    toast("Snap sent");
  };

  // (Optional) chat camera shortcut = go camera screen
  btnChatSnap.onclick = ()=>{ setScreen(1); toast("Take snap then Send Snap"); };

  // ---------- VOICE NOTES (hold to record) ----------
  async function startVoice(){
    if(recordingAudio || !activeRoomId) return;
    try{
      recordingAudio=true;
      btnMic.classList.add("rec");
      micChunks=[];
      micStream = await navigator.mediaDevices.getUserMedia({audio:true});
      const mime = (window.MediaRecorder && MediaRecorder.isTypeSupported("audio/webm")) ? "audio/webm" : "";
      micRecorder = new MediaRecorder(micStream, mime?{mimeType:mime}:undefined);
      micRecorder.ondataavailable = e => micChunks.push(e.data);
      micRecorder.start();
    }catch{
      recordingAudio=false;
      btnMic.classList.remove("rec");
      toast("Allow microphone");
    }
  }

  async function stopVoice(){
    if(!recordingAudio) return;
    recordingAudio=false;
    btnMic.classList.remove("rec");
    try{ micRecorder.stop(); }catch{}
    micRecorder.onstop = async ()=>{
      try{ micStream.getTracks().forEach(t=>t.stop()); }catch{}
      const blob = new Blob(micChunks,{type: micRecorder.mimeType || "audio/webm"});
      const r = ref(storage,`voice/${me.uid}/${Date.now()}.webm`);
      await uploadBytes(r,blob,{contentType: blob.type});
      const url = await getDownloadURL(r);

      await addDoc(collection(db,"rooms",activeRoomId,"messages"),{
        type:"audio",
        mediaURL:url,
        uid:me.uid,
        fromName: meProfile?.displayName || meProfile?.username || "",
        createdAt:serverTimestamp()
      });

      await setDoc(doc(db,"rooms",activeRoomId),{ lastPreview:"üéôÔ∏è Voice", updatedAt:serverTimestamp() },{merge:true});
    };
  }

  btnMic.addEventListener("touchstart", startVoice, {passive:true});
  btnMic.addEventListener("touchend", stopVoice, {passive:true});
  // fallback for non-touch
  btnMic.addEventListener("mousedown", startVoice);
  btnMic.addEventListener("mouseup", stopVoice);

  // ---------- OTHER USER PRESENCE + HEADER AVATAR ----------
  async function setupChatHeaderPresence(room){
    if(room.type!=="dm") return;

    const otherUid = room.members.find(u=>u!==me.uid);
    const uref = doc(db,"users",otherUid);

    otherUserUnsub = onSnapshot(uref,(s)=>{
      const d=s.data()||{};
      onlineIndicator.classList.toggle("hidden", !d.online);
      userPresence.textContent = d.online ? "Online" : "Offline";

      userSheetTitle.textContent = d.displayName || d.username || "User";
      userSnapscore.textContent = d.snapscore || 0;
      userTextscore.textContent = d.textscore || 0;

      // chat pill = their pfp like Snapchat bitmoji slot
      if(d.photoURL){
        chatPill.innerHTML = `<img src="${d.photoURL}"/>`;
      }else{
        chatPill.textContent = (d.displayName || d.username || "U")[0];
      }
    });
  }

  // ---------- PROFILE / SCORES ----------
  async function refreshMeProfile(){
    const s = await getDoc(doc(db,"users",me.uid));
    meProfile = s.data() || {};
    mySnapscore.textContent = meProfile.snapscore || 0;
    myTextscore.textContent = meProfile.textscore || 0;
  }

  function paintMePill(){
    if(meProfile?.photoURL) mePill.innerHTML = `<img src="${meProfile.photoURL}"/>`;
    else mePill.textContent = (meProfile?.displayName || "I")[0];
  }

  // basic pfp upload without cropper logic (still works)
  let croppedPfpBlob = null;
  btnCropPfp.onclick = ()=>{
    const f = pfpFile.files?.[0];
    if(!f){ toast("Pick a photo first"); return; }
    // simple: use original file as "cropped" for now
    croppedPfpBlob = f;
    toast("Ready to save");
  };

  btnSaveProfile.onclick = async ()=>{
    if(!me) return;
    profileMsg.textContent = "";
    try{
      const updates = {};
      if(displayName.value.trim()) updates.displayName = displayName.value.trim();

      if(croppedPfpBlob){
        const r = ref(storage,`pfps/${me.uid}.jpg`);
        await uploadBytes(r, croppedPfpBlob, {contentType:"image/jpeg"});
        updates.photoURL = await getDownloadURL(r);
        croppedPfpBlob = null;
      }

      if(Object.keys(updates).length) await setDoc(doc(db,"users",me.uid), updates, {merge:true});
      await refreshMeProfile();
      paintMePill();
      profileMsg.textContent = "Saved";
      toast("Saved");
    }catch(e){
      profileMsg.textContent = e.message;
    }
  };

  // ---------- ROOMS LIST ----------
  function listenRooms(){
    const qRooms = query(collection(db,"rooms"), where("members","array-contains",me.uid), orderBy("updatedAt","desc"), limit(50));
    onSnapshot(qRooms, async (snap)=>{
      chatList.innerHTML = "";
      for(const d of snap.docs){
        const r = d.data();
        const otherUid = (r.type==="dm") ? r.members.find(u=>u!==me.uid) : null;

        let title = r.name || "Chat";
        let photoURL = "";
        let online = false;

        if(otherUid){
          const u = await getDoc(doc(db,"users",otherUid));
          const ud = u.data()||{};
          title = ud.displayName || ud.username || "User";
          photoURL = ud.photoURL || "";
          online = !!ud.online;
        }

        const row = document.createElement("div");
        row.className = "row";
        row.innerHTML = `
          <div class="who">
            <div class="avatar">
              ${photoURL ? `<img src="${photoURL}"/>` : title[0]}
              <div class="onlineDot ${online?"on":""}"></div>
            </div>
            <div class="meta">
              <div class="name">${title}</div>
              <div class="sub">${r.lastPreview || "Tap to open"}</div>
            </div>
          </div>
        `;
        row.onclick = ()=>openRoom(d.id, { ...r, title });
        chatList.appendChild(row);
      }
    });
  }

  // ---------- AUTH STATE ----------
  onAuthStateChanged(auth, async (u)=>{
    if(u){
      me = u;
      authScreen.classList.add("hidden");
      mainApp.classList.remove("hidden");

      await refreshMeProfile();
      paintMePill();

      startPresence();
      setScreen(1);
      await startCamera();

      listenRooms();
      listenRequests();
    }else{
      stopPresence();
      mainApp.classList.add("hidden");
      authScreen.classList.remove("hidden");
      await stopCamera();
      closeChat();
    }
  });
</script>
</body>
</html>

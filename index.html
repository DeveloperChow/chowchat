<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#000000" />
  <title>Chow Chat</title>

  <style>
    :root { --bg:#000; --panel:#0b0b0b; --line:#1b1b1b; --text:#fff; --muted:#9aa0a6; --snap:#fffc00; --blue:#00b2ff; }
    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
    html,body{height:100%; margin:0; background:var(--bg); color:var(--text); font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;}
    #app{height:100%; display:flex; flex-direction:column; padding-top:env(safe-area-inset-top); padding-bottom:env(safe-area-inset-bottom);}
    .hidden{display:none!important;}

    .topbar{height:52px; display:flex; align-items:center; justify-content:space-between; padding:0 12px; border-bottom:1px solid var(--line); background:rgba(0,0,0,.85); backdrop-filter:blur(10px);}
    .topbar .left,.topbar .right{display:flex; align-items:center; gap:10px;}
    .pill{width:34px; height:34px; border-radius:50%; background:#222; display:grid; place-items:center; font-weight:900; overflow:hidden;}
    .pill img{width:100%; height:100%; object-fit:cover;}
    .iconbtn{position:relative; width:34px;height:34px;border-radius:10px;background:#111;border:1px solid #222;color:#fff;display:grid;place-items:center;font-size:16px;}
    .badge{position:absolute; top:-6px; right:-6px; min-width:18px; height:18px; padding:0 5px; border-radius:999px; background:#ff2a2a; color:#fff; font-size:11px; display:grid; place-items:center; border:2px solid #000;}
    .title{font-weight:900; letter-spacing:.2px; display:flex; align-items:center; gap:8px;}
    .typingDot{width:10px;height:10px;border-radius:50%; background:var(--blue); animation:pulse 1.1s infinite ease-in-out;}
    @keyframes pulse { 0%{transform:scale(.6);opacity:.35} 50%{transform:scale(1);opacity:1} 100%{transform:scale(.6);opacity:.35} }

    .chips{display:flex; gap:8px; padding:10px 12px; overflow:auto; border-bottom:1px solid var(--line);}
    .chip{padding:7px 12px; border-radius:18px; background:#101010; border:1px solid #222; color:#cfcfcf; font-size:13px; white-space:nowrap;}
    .chip.active{background:#1a1a1a; border-color:#333; color:#fff;}

    .screenWrap{flex:1; overflow:hidden; position:relative;}
    .screens{height:100%; display:flex; width:300%; transform:translateX(-100%); transition:transform .22s ease;}
    .screen{width:100%; height:100%; overflow:auto; background:var(--bg);}

    /* Camera */
    .screen.camera{position:relative; background:#000;}
    #camVideo{position:absolute; inset:0; width:100%; height:100%; object-fit:cover; background:#000;}
    .cameraTools{position:absolute; right:10px; top:80px; display:flex; flex-direction:column; gap:10px; pointer-events:auto;}
    .tool{width:38px;height:38px;border-radius:12px;background:#111;border:1px solid #222; display:grid; place-items:center; color:#fff; opacity:.95}
    .camBottom{position:absolute; left:0; right:0; bottom:66px; display:flex; justify-content:center; gap:12px; pointer-events:auto;}
    .shutter{width:76px;height:76px;border-radius:50%; border:6px solid #fff; background:transparent;}
    .snapBtn{padding:0 12px; height:44px; border-radius:16px; border:1px solid #222; background:var(--snap); color:#000; font-weight:900;}

    /* Chats list */
    .chatList{padding:6px 0;}
    .row{display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid #111;}
    .row .who{display:flex; align-items:center; gap:10px; min-width:0;}
    .avatar{width:44px;height:44px;border-radius:50%; background:#222; display:grid; place-items:center; font-weight:900; overflow:hidden;}
    .avatar img{width:100%; height:100%; object-fit:cover;}
    .meta{min-width:0;}
    .name{font-weight:900; font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:220px;}
    .sub{color:var(--muted); font-size:12.5px; margin-top:3px;}
    .rightIcons{display:flex; gap:8px;}
    .tiny{width:30px;height:30px;border-radius:10px;background:#0f0f0f;border:1px solid #222; display:grid; place-items:center; color:#fff; font-size:14px;}

    /* Bottom nav */
    .nav{height:58px; border-top:1px solid var(--line); display:flex; justify-content:space-around; align-items:center; background:rgba(0,0,0,.92); backdrop-filter:blur(10px);}
    .navbtn{width:54px;height:44px;border-radius:18px; display:grid; place-items:center; color:#bbb; border:1px solid transparent;}
    .navbtn.active{color:#000; background:var(--snap); border-color:#d8d100;}
    .navbtn.cam{width:70px;height:48px; border-radius:22px; background:#111; border:1px solid #222; color:#fff;}
    .navbtn.cam.active{background:var(--snap); color:#000; border-color:#d8d100;}

    /* Auth */
    .auth{height:100%; display:flex; align-items:center; justify-content:center; padding:18px;}
    .card{width:100%; max-width:420px; border:1px solid #222; background:#070707; border-radius:18px; padding:16px;}
    .card h2{margin:0 0 10px; font-size:18px;}
    .in{width:100%; padding:12px 12px; margin:8px 0; border-radius:12px; border:1px solid #222; background:#0d0d0d; color:#fff; font-size:14px;}
    .btn{width:100%; padding:12px; margin-top:10px; border-radius:12px; border:1px solid #222; background:#141414; color:#fff; font-weight:900;}
    .btn.snap{background:var(--snap); color:#000; border-color:#d8d100;}
    .small{color:var(--muted); font-size:12px; margin-top:10px; line-height:1.4;}

    /* Chat */
    .chatPanel{height:100%; display:flex; flex-direction:column;}
    .msgs{flex:1; overflow:auto; padding:12px; display:flex; flex-direction:column; gap:8px; background-size:cover; background-position:center; background-repeat:no-repeat;}
    .bubble{max-width:78%; padding:10px 12px; border-radius:16px; border:1px solid #222; background:rgba(15,15,15,.92); backdrop-filter:blur(6px);}
    .bubble.me{align-self:flex-end; background:rgba(26,26,26,.92); border-color:#2a2a2a;}
    .bubble img{max-width:100%; border-radius:14px; display:block;}
    .bubble .t{font-size:14px;}
    .bubble .s{margin-top:3px; font-size:11px; color:var(--muted);}
    .send{display:flex; gap:8px; padding:10px 10px calc(10px + env(safe-area-inset-bottom)); border-top:1px solid #111; background:#060606;}
    .send input{flex:1; padding:12px; border-radius:16px; border:1px solid #222; background:#0d0d0d; color:#fff;}
    .send button{padding:0 14px; border-radius:16px; border:1px solid #222; background:var(--snap); color:#000; font-weight:900;}
    .miniBtn{padding:0 10px; height:34px; border-radius:14px; border:1px solid #222; background:#111; color:#fff; font-weight:900;}

    /* Sheets */
    .sheet{position:fixed; inset:0; background:rgba(0,0,0,.65); display:none; z-index:60;}
    .sheet.on{display:block;}
    .sheetCard{position:absolute; left:10px; right:10px; bottom:10px; border-radius:18px; background:#070707; border:1px solid #222; padding:12px;}
    .sheetTitle{font-weight:900; margin:0 0 8px;}
    .sheetRow{display:flex; gap:10px; margin-top:10px;}
    .sheetRow input{flex:1;}
    .list{max-height:240px; overflow:auto; border:1px solid #222; border-radius:14px; background:#050505;}
    .li{padding:10px 12px; border-bottom:1px solid #111; display:flex; justify-content:space-between; gap:10px; align-items:center;}
    .li:last-child{border-bottom:none;}
    .li .left{min-width:0;}
    .li .t{font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:220px;}
    .li .d{color:var(--muted); font-size:12px; margin-top:2px;}
    .li button{border-radius:12px; border:1px solid #222; background:#111; color:#fff; padding:8px 10px; font-weight:900;}
    .li button.snap{background:var(--snap); color:#000; border-color:#d8d100;}
  </style>
</head>

<body>
<div id="app">
  <!-- AUTH -->
  <div id="authScreen" class="auth">
    <div class="card">
      <h2>Sign in</h2>
      <input id="email" class="in" placeholder="Email" autocomplete="email" />
      <input id="pass" class="in" placeholder="Password" type="password" autocomplete="current-password" />
      <input id="username" class="in" placeholder="Username (signup only, no spaces)" autocapitalize="none" />
      <button id="btnLogin" class="btn snap">Login</button>
      <button id="btnSignup" class="btn">Create account</button>
      <div class="small" id="authMsg"></div>
    </div>
  </div>

  <!-- APP -->
  <div id="mainApp" class="hidden" style="height:100%; display:flex; flex-direction:column;">
    <div class="topbar">
      <div class="left">
        <div class="pill" id="mePill">I</div>
        <div class="iconbtn" id="btnSearch">üîé</div>
      </div>

      <div class="title" id="topTitle">
        <span id="topTitleText">Camera</span>
      </div>

      <div class="right">
        <div class="iconbtn">üîî</div>
        <div class="iconbtn" id="btnAdd">‚ûï<span id="addBadge" class="badge hidden">0</span></div>
        <div class="iconbtn" id="btnMenu">‚ãØ</div>
      </div>
    </div>

    <div id="chipsBar" class="chips hidden">
      <div class="chip active">All</div>
      <div class="chip">Unread</div>
      <div class="chip">Streaks</div>
      <div class="chip">Stories</div>
      <div class="chip">Calls</div>
      <div class="chip">Groups</div>
    </div>

    <div class="screenWrap" id="swipeRoot">
      <div class="screens" id="screens">

        <!-- CHATS -->
        <div class="screen" id="screenChats">
          <div class="chatList" id="chatList"></div>
        </div>

        <!-- CAMERA -->
        <div class="screen camera" id="screenCamera">
          <video id="camVideo" autoplay playsinline muted></video>
          <div class="cameraTools" id="cameraTools">
            <div class="tool" id="btnFlipCam">üîÅ</div>
            <div class="tool" id="btnCamOnOff">‚èª</div>
          </div>
          <div class="camBottom">
            <button class="shutter" id="btnShutter" aria-label="Shutter"></button>
            <button class="snapBtn" id="btnSendSnap" aria-label="Send Snap">Send Snap</button>
          </div>
        </div>

        <!-- STORIES -->
        <div class="screen" id="screenStories">
          <div style="padding:18px; color:#bbb;">
            <div style="font-weight:900; color:#fff;">Stories</div>
            <div style="margin-top:6px;">Placeholder</div>
          </div>
        </div>

      </div>
    </div>

    <div class="nav">
      <div class="navbtn" id="navChats">üí¨</div>
      <div class="navbtn cam active" id="navCam">‚¨§</div>
      <div class="navbtn" id="navStories">‚ñ∂Ô∏è</div>
      <div class="navbtn" id="navProfile">üë§</div>
      <div class="navbtn" id="navLogout">‚éã</div>
    </div>
  </div>
</div>

<!-- CHAT MODAL -->
<div id="chatModal" class="hidden" style="position:fixed; inset:0; background:#000; z-index:55; display:flex; flex-direction:column;">
  <div class="topbar">
    <div class="left">
      <div class="iconbtn" id="btnBack">‚Üê</div>
      <div class="title">
        <span id="chatTitle">Chat</span>
        <span id="typingIndicator" class="hidden typingDot"></span>
      </div>
    </div>
    <div class="right">
      <button class="miniBtn" id="btnWallpaper">Wallpaper</button>
      <button class="miniBtn" id="btnNick">Name</button>
      <div class="iconbtn" id="btnSignOutMini">‚éã</div>
    </div>
  </div>
  <div class="chatPanel">
    <div class="msgs" id="msgs"></div>
    <div class="send">
      <input id="msgInput" placeholder="Send a chat" />
      <button id="sendBtn">Send</button>
    </div>
  </div>
</div>

<!-- ADD FRIENDS / REQUESTS -->
<div id="addSheet" class="sheet">
  <div class="sheetCard">
    <div class="sheetTitle">Add Friends</div>
    <div class="sheetRow">
      <input id="findUser" class="in" placeholder="Search username" autocapitalize="none" />
      <button id="btnSendReq" class="btn snap" style="width:auto; margin:0; padding:10px 12px;">Add</button>
    </div>

    <div style="margin-top:10px; font-weight:900;">Recently Added</div>
    <div class="list" id="recentList" style="margin-top:8px;"></div>

    <div style="margin-top:12px; font-weight:900;">Added You</div>
    <div class="list" id="requestsList" style="margin-top:8px;"></div>

    <div class="sheetRow">
      <button id="btnCloseAdd" class="btn" style="margin:0;">Close</button>
      <button id="btnCreateGroup" class="btn snap" style="margin:0;">Create Group</button>
    </div>
  </div>
</div>

<!-- PROFILE -->
<div id="profileSheet" class="sheet">
  <div class="sheetCard">
    <div class="sheetTitle">Profile</div>
    <input id="displayName" class="in" placeholder="Display name" />
    <div class="sheetRow">
      <input id="pfpFile" type="file" accept="image/*" class="in" style="padding:10px;" />
      <button id="btnSaveProfile" class="btn snap" style="width:auto; margin:0; padding:10px 12px;">Save</button>
    </div>
    <div class="small" id="profileMsg"></div>
    <div class="sheetRow">
      <button id="btnCloseProfile" class="btn" style="margin:0;">Close</button>
      <button id="btnAdmin" class="btn" style="margin:0;">Admin</button>
    </div>
  </div>
</div>

<!-- ADMIN -->
<div id="adminSheet" class="sheet">
  <div class="sheetCard">
    <div class="sheetTitle">Admin Panel</div>
    <div class="small">Only your UID can open this (set ADMIN_UID in code)</div>
    <input id="adminTargetUid" class="in" placeholder="Target user UID" />
    <input id="adminSetName" class="in" placeholder="Set display name" />
    <div class="sheetRow">
      <button id="btnAdminSetName" class="btn snap" style="margin:0;">Update User</button>
      <button id="btnCloseAdmin" class="btn" style="margin:0;">Close</button>
    </div>
    <div class="small" id="adminMsg"></div>
  </div>
</div>

<input id="wallFile" type="file" accept="image/*" class="hidden" />

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore,
    doc, setDoc, getDoc, updateDoc,
    collection, addDoc, query, where, orderBy, limit, onSnapshot, serverTimestamp, getDocs
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import {
    getStorage, ref, uploadBytes, getDownloadURL
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

  // üîê SET THIS: login once, then check console or Firebase Auth UID and paste it here
  const ADMIN_UID = "PUT_YOUR_UID_HERE";

  // ‚úÖ YOUR FIREBASE CONFIG (NORMAL QUOTES)
  const firebaseConfig = {
    apiKey: "AIzaSyA4iSXdKxbyvnD8yMZrl3VW73gvvgU74ik",
    authDomain: "chowchat.firebaseapp.com",
    projectId: "chowchat",
    storageBucket: "chowchat.firebasestorage.app",
    messagingSenderId: "624312959317",
    appId: "1:624312959317:web:e8ab9a416958804e832fdc"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  const $ = (id) => document.getElementById(id);

  // UI refs
  const authScreen = $("authScreen"), mainApp = $("mainApp"), authMsg = $("authMsg");
  const mePill = $("mePill");
  const screens = $("screens"), chipsBar = $("chipsBar"), topTitleText = $("topTitleText");
  const navChats = $("navChats"), navCam = $("navCam"), navStories = $("navStories"), navProfile = $("navProfile"), navLogout = $("navLogout");
  const btnAdd = $("btnAdd"), addBadge = $("addBadge"), addSheet = $("addSheet");
  const chatList = $("chatList");
  const recentList = $("recentList"), requestsList = $("requestsList");
  const chatModal = $("chatModal"), btnBack = $("btnBack"), chatTitle = $("chatTitle"), typingIndicator = $("typingIndicator");
  const msgs = $("msgs"), msgInput = $("msgInput"), sendBtn = $("sendBtn");
  const btnWallpaper = $("btnWallpaper"), wallFile = $("wallFile");
  const btnNick = $("btnNick");
  const profileSheet = $("profileSheet"), btnSaveProfile = $("btnSaveProfile"), profileMsg = $("profileMsg"), pfpFile = $("pfpFile"), displayName = $("displayName");
  const adminSheet = $("adminSheet"), btnAdmin = $("btnAdmin"), btnAdminSetName = $("btnAdminSetName"), adminMsg = $("adminMsg"), adminTargetUid = $("adminTargetUid"), adminSetName = $("adminSetName");
  const findUser = $("findUser"), btnSendReq = $("btnSendReq"), btnCreateGroup = $("btnCreateGroup");
  const btnCloseAdd = $("btnCloseAdd"), btnCloseProfile = $("btnCloseProfile"), btnCloseAdmin = $("btnCloseAdmin");
  const btnSignOutMini = $("btnSignOutMini");

  // Camera
  const camVideo = $("camVideo"), btnFlipCam = $("btnFlipCam"), btnCamOnOff = $("btnCamOnOff"), btnSendSnap = $("btnSendSnap");
  let camStream = null;
  let facing = "user";
  let camOn = true;
  let lastSnapBlob = null;

  // app state
  let me = null;
  let meProfile = null;
  let screenIndex = 1; // chats=0, cam=1, stories=2
  let activeRoomId = null;
  let activeRoom = null;
  let activeRoomUnsub = null;
  let typingUnsub = null;

  // local nickname + wallpaper (per room)
  const nickKey = (roomId) => `nick_${me?.uid}_${roomId}`;
  const wallKey = (roomId) => `wall_${me?.uid}_${roomId}`;

  // Helpers
  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
  function utcDayKey(d=new Date()){
    const y=d.getUTCFullYear();
    const m=String(d.getUTCMonth()+1).padStart(2,"0");
    const da=String(d.getUTCDate()).padStart(2,"0");
    return `${y}-${m}-${da}`;
  }
  function yesterdayKey(){
    const d=new Date();
    d.setUTCDate(d.getUTCDate()-1);
    return utcDayKey(d);
  }
  function idForPair(a,b){ return [a,b].sort().join("_"); }
  function isAdmin(){ return me?.uid && me.uid === ADMIN_UID; }

  // UI: screens
  const setScreen = (i) => {
    screenIndex = Math.max(0, Math.min(2, i));
    screens.style.transform = `translateX(${-(screenIndex*100)}%)`;
    navChats.classList.toggle("active", screenIndex===0);
    navCam.classList.toggle("active", screenIndex===1);
    navStories.classList.toggle("active", screenIndex===2);

    if (screenIndex===0){
      chipsBar.classList.remove("hidden");
      topTitleText.textContent = "Chat";
    } else if (screenIndex===1){
      chipsBar.classList.add("hidden");
      topTitleText.textContent = "Camera";
    } else {
      chipsBar.classList.add("hidden");
      topTitleText.textContent = "Stories";
    }
  };

  navChats.onclick = () => setScreen(0);
  navCam.onclick = () => setScreen(1);
  navStories.onclick = () => setScreen(2);
  navProfile.onclick = () => profileSheet.classList.add("on");
  navLogout.onclick = async () => { await signOut(auth); };

  // Swipe
  const swipeRoot = $("swipeRoot");
  let startX = 0, dx = 0, dragging = false;
  swipeRoot.addEventListener("touchstart", (e) => {
    if (!chatModal.classList.contains("hidden")) return;
    dragging = true; dx = 0; startX = e.touches[0].clientX;
    screens.style.transition = "none";
  }, {passive:true});
  swipeRoot.addEventListener("touchmove", (e) => {
    if (!dragging) return;
    dx = e.touches[0].clientX - startX;
    const pct = (dx / window.innerWidth) * 100;
    screens.style.transform = `translateX(${-(screenIndex*100) + pct}%)`;
  }, {passive:true});
  swipeRoot.addEventListener("touchend", () => {
    if (!dragging) return;
    dragging = false;
    screens.style.transition = "transform .22s ease";
    if (dx > 60) setScreen(screenIndex - 1);
    else if (dx < -60) setScreen(screenIndex + 1);
    else setScreen(screenIndex);
  });

  // AUTH
  $("btnLogin").onclick = async () => {
    authMsg.textContent = "";
    const email = $("email").value.trim();
    const pass = $("pass").value;
    try { await signInWithEmailAndPassword(auth, email, pass); }
    catch (e) { authMsg.textContent = e.message; }
  };

  $("btnSignup").onclick = async () => {
    authMsg.textContent = "";
    const email = $("email").value.trim();
    const pass = $("pass").value;
    const uname = $("username").value.trim().toLowerCase();
    if(!uname || /\s/.test(uname)) { authMsg.textContent = "Username required (no spaces)"; return; }

    // ensure username unique
    const uq = query(collection(db,"users"), where("username","==", uname), limit(1));
    const ex = await getDocs(uq);
    if(!ex.empty){ authMsg.textContent = "Username taken"; return; }

    try {
      const cred = await createUserWithEmailAndPassword(auth, email, pass);
      const u = cred.user;
      await setDoc(doc(db, "users", u.uid), {
        uid: u.uid,
        email,
        username: uname,
        displayName: uname,
        photoURL: "",
        createdAt: serverTimestamp()
      }, { merge:true });
    } catch (e) { authMsg.textContent = e.message; }
  };

  // PROFILE save (displayName + pfp)
  btnSaveProfile.onclick = async () => {
    if(!me) return;
    profileMsg.textContent = "";
    try{
      const userRef = doc(db,"users", me.uid);
      const updates = {};
      if(displayName.value.trim()) updates.displayName = displayName.value.trim();

      if(pfpFile.files && pfpFile.files[0]){
        const file = pfpFile.files[0];
        const r = ref(storage, `pfps/${me.uid}.jpg`);
        await uploadBytes(r, file);
        const url = await getDownloadURL(r);
        updates.photoURL = url;
      }
      if(Object.keys(updates).length) await setDoc(userRef, updates, {merge:true});
      profileMsg.textContent = "Saved";
    }catch(e){ profileMsg.textContent = e.message; }
  };

  btnCloseProfile.onclick = () => profileSheet.classList.remove("on");

  // ADMIN
  btnAdmin.onclick = () => {
    if(!isAdmin()){ alert("Not admin"); return; }
    adminSheet.classList.add("on");
  };
  btnCloseAdmin.onclick = () => adminSheet.classList.remove("on");
  btnAdminSetName.onclick = async () => {
    adminMsg.textContent = "";
    if(!isAdmin()) { adminMsg.textContent = "Not admin"; return; }
    const tuid = adminTargetUid.value.trim();
    const nm = adminSetName.value.trim();
    if(!tuid || !nm) { adminMsg.textContent = "Need UID + name"; return; }
    try{
      await setDoc(doc(db,"users", tuid), { displayName: nm }, {merge:true});
      adminMsg.textContent = "Updated";
    }catch(e){ adminMsg.textContent = e.message; }
  };

  // ADD FRIENDS sheet
  btnAdd.onclick = () => addSheet.classList.add("on");
  btnCloseAdd.onclick = () => addSheet.classList.remove("on");

  async function resolveUserByUsername(uname){
    const qy = query(collection(db,"users"), where("username","==", uname.toLowerCase()), limit(1));
    const snap = await getDocs(qy);
    if(snap.empty) return null;
    return snap.docs[0].data();
  }

  // send friend request -> goes to "recently added"
  btnSendReq.onclick = async () => {
    if(!me) return;
    const uname = findUser.value.trim().toLowerCase();
    if(!uname) return;
    const user = await resolveUserByUsername(uname);
    if(!user){ alert("User not found"); return; }
    if(user.uid === me.uid){ alert("That‚Äôs you"); return; }

    const reqId = `${me.uid}_${user.uid}`;
    await setDoc(doc(db,"friendRequests", reqId), {
      id: reqId,
      from: me.uid,
      to: user.uid,
      fromUsername: meProfile?.username || "",
      toUsername: user.username || "",
      status: "pending",
      createdAt: serverTimestamp()
    }, {merge:true});

    await setDoc(doc(db,"recentlyAdded", `${me.uid}_${user.uid}`), {
      owner: me.uid,
      other: user.uid,
      otherUsername: user.username || "",
      createdAt: serverTimestamp()
    }, {merge:true});

    findUser.value = "";
  };

  // accept request -> create friendship + DM room; only then chat appears
  async function acceptRequest(reqDoc){
    const otherUid = reqDoc.from;
    const frId = idForPair(me.uid, otherUid);

    // mark accepted
    await setDoc(doc(db,"friendRequests", reqDoc.id), { status:"accepted", acceptedAt: serverTimestamp() }, {merge:true});

    // create friendship
    await setDoc(doc(db,"friends", frId), {
      id: frId,
      members: [me.uid, otherUid].sort(),
      createdAt: serverTimestamp()
    }, {merge:true});

    // create DM room
    const roomId = `dm_${frId}`;
    await setDoc(doc(db,"rooms", roomId), {
      id: roomId,
      type: "dm",
      members: [me.uid, otherUid],
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp(),
      lastPreview: "",
      streakCount: 0,
      streakLastDay: null,
      snappedToday: {}
    }, {merge:true});

    // clear "added you" badge for this one by deleting request entry in inbox list (optional)
  }

  async function declineRequest(reqDoc){
    await setDoc(doc(db,"friendRequests", reqDoc.id), { status:"declined" }, {merge:true});
  }

  // Group creation from friends (simple: uses all accepted friends you recently added)
  btnCreateGroup.onclick = async () => {
    if(!me) return;
    // simplest: create empty group, then you can add friends later (v2)
    const gid = `grp_${me.uid}_${Date.now()}`;
    await setDoc(doc(db,"rooms", gid), {
      id: gid,
      type: "group",
      name: "Group",
      owner: me.uid,
      members: [me.uid],
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp(),
      lastPreview: "",
      streakCount: 0,
      streakLastDay: null,
      snappedToday: {}
    }, {merge:true});
    alert("Group created (add members in v2)");
  };

  // Chat open
  btnBack.onclick = () => closeChat();
  btnSignOutMini.onclick = async () => { await signOut(auth); };

  function closeChat(){
    chatModal.classList.add("hidden");
    activeRoomId = null;
    activeRoom = null;
    if(activeRoomUnsub) activeRoomUnsub();
    if(typingUnsub) typingUnsub();
    activeRoomUnsub = null;
    typingUnsub = null;
    msgs.style.backgroundImage = "";
    typingIndicator.classList.add("hidden");
  }

  // Wallpaper
  btnWallpaper.onclick = () => wallFile.click();
  wallFile.addEventListener("change", async () => {
    if(!activeRoomId) return;
    const f = wallFile.files?.[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = () => {
      const url = reader.result;
      localStorage.setItem(wallKey(activeRoomId), url);
      msgs.style.backgroundImage = `url('${url}')`;
    };
    reader.readAsDataURL(f);
  });

  // Nickname (local)
  btnNick.onclick = () => {
    if(!activeRoomId) return;
    const cur = localStorage.getItem(nickKey(activeRoomId)) || "";
    const n = prompt("Custom name for this chat", cur);
    if(n === null) return;
    localStorage.setItem(nickKey(activeRoomId), n);
    chatTitle.textContent = n || (activeRoom?.title || "Chat");
  };

  // TYPING indicator (Snap-style blue dot)
  let typingTimer = null;
  msgInput.addEventListener("input", async () => {
    if(!me || !activeRoomId) return;
    const myTypingRef = doc(db,"rooms",activeRoomId,"typing",me.uid);
    await setDoc(myTypingRef, { uid: me.uid, typing:true, at: serverTimestamp() }, {merge:true});
    clearTimeout(typingTimer);
    typingTimer = setTimeout(async () => {
      await setDoc(myTypingRef, { typing:false }, {merge:true});
    }, 900);
  });

  function listenTyping(){
    if(!activeRoomId) return;
    const qy = query(collection(db,"rooms",activeRoomId,"typing"));
    typingUnsub = onSnapshot(qy, (snap) => {
      let otherTyping = false;
      snap.forEach(d=>{
        const t = d.data();
        if(t.uid !== me.uid && t.typing === true) otherTyping = true;
      });
      typingIndicator.classList.toggle("hidden", !otherTyping);
    });
  }

  // STREAKS (snap-only) DM: both snap today, GROUP: all snap today
  async function updateSnapStreak(roomId, senderUid){
    const roomRef = doc(db, "rooms", roomId);
    const snap = await getDoc(roomRef);
    if(!snap.exists()) return;

    const room = snap.data();
    const members = Array.isArray(room.members) ? room.members : [];

    const today = utcDayKey();
    const yKey = yesterdayKey();

    let streakCount = room.streakCount || 0;
    let streakLastDay = room.streakLastDay || null;
    let snappedToday = room.snappedToday || {}; // {uid:true/false}

    snappedToday = { ...(snappedToday||{}), [senderUid]: true };
    const allDone = members.length >= 2 && members.every(uid => snappedToday[uid] === true);

    if(allDone){
      if(streakLastDay !== today){
        streakCount = (streakLastDay === yKey) ? (streakCount + 1) : 1;
        streakLastDay = today;
      }
      const reset = {};
      members.forEach(uid => reset[uid] = false);
      snappedToday = reset;
    }

    await setDoc(roomRef, {
      streakCount,
      streakLastDay,
      snappedToday,
      updatedAt: serverTimestamp()
    }, { merge:true });
  }

  // MESSAGES listener + render
  function openRoom(roomId, roomData){
    activeRoomId = roomId;
    activeRoom = roomData;

    chatModal.classList.remove("hidden");
    const nick = localStorage.getItem(nickKey(roomId)) || "";
    chatTitle.textContent = nick || roomData.title || roomData.name || "Chat";

    const wall = localStorage.getItem(wallKey(roomId));
    msgs.style.backgroundImage = wall ? `url('${wall}')` : "";

    if(activeRoomUnsub) activeRoomUnsub();
    if(typingUnsub) typingUnsub();
    listenTyping();

    const qMsgs = query(collection(db,"rooms",roomId,"messages"), orderBy("createdAt","desc"), limit(60));
    activeRoomUnsub = onSnapshot(qMsgs, (snap) => {
      const arr = [];
      snap.forEach(d => arr.push({ id:d.id, ...d.data() }));
      arr.reverse();

      msgs.innerHTML = "";
      for(const m of arr){
        const div = document.createElement("div");
        div.className = "bubble" + (m.uid===me.uid ? " me" : "");
        if(m.type === "snap" && m.mediaURL){
          div.innerHTML = `<img /><div class="s"></div>`;
          div.querySelector("img").src = m.mediaURL;
          div.querySelector(".s").textContent = m.fromName || m.email || "";
        }else{
          div.innerHTML = `<div class="t"></div><div class="s"></div>`;
          div.querySelector(".t").textContent = m.text || "";
          div.querySelector(".s").textContent = m.fromName || m.email || "";
        }
        msgs.appendChild(div);
      }
      msgs.scrollTop = msgs.scrollHeight;
    });
  }

  // SEND TEXT (does NOT affect streaks)
  async function sendText(){
    if(!me || !activeRoomId) return;
    const text = msgInput.value.trim();
    if(!text) return;
    msgInput.value = "";

    await addDoc(collection(db,"rooms",activeRoomId,"messages"), {
      type:"text",
      text,
      uid: me.uid,
      email: me.email,
      fromName: meProfile?.displayName || meProfile?.username || "",
      createdAt: serverTimestamp()
    });

    await setDoc(doc(db,"rooms",activeRoomId), {
      lastPreview: text,
      updatedAt: serverTimestamp()
    }, {merge:true});
  }

  sendBtn.onclick = sendText;
  msgInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") sendText(); });

  // CAMERA (front/rear switch)
  async function startCamera(){
    try{
      if(camStream){
        camStream.getTracks().forEach(t=>t.stop());
        camStream=null;
      }
      camStream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: facing },
        audio: false

      });
      camVideo.srcObject = camStream;
      camOn = true;
    } catch (e){
      alert("Camera blocked. Allow camera permission in Safari settings.");
      camOn = false;
    }
  }

  async function stopCamera(){
    if(camStream){
      camStream.getTracks().forEach(t=>t.stop());
      camStream = null;
    }
    camOn = false;
  }

  btnFlipCam.onclick = async () => {
    facing = (facing === "user") ? "environment" : "user";
    if(camOn) await startCamera();
  };

  btnCamOnOff.onclick = async () => {
    if(camOn) await stopCamera();
    else await startCamera();
  };

  // Capture frame to blob
  $("btnShutter").onclick = async () => {
    if(!camOn || !camVideo.videoWidth) { alert("Camera not ready"); return; }
    const canvas = document.createElement("canvas");
    canvas.width = camVideo.videoWidth;
    canvas.height = camVideo.videoHeight;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(camVideo, 0, 0, canvas.width, canvas.height);
    lastSnapBlob = await new Promise(res => canvas.toBlob(res, "image/jpeg", 0.9));
    alert("Snap captured. Tap Send Snap.");
  };

  // Upload snap blob -> Storage -> message type snap -> update streak
  async function uploadSnap(blob){
    const path = `snaps/${me.uid}/${Date.now()}.jpg`;
    const r = ref(storage, path);
    await uploadBytes(r, blob);
    return await getDownloadURL(r);
  }

  // Pick recipient room to send snap (if no active room open)
  async function pickRoomToSend(){
    // simplest: if you last opened a room, send there
    if(activeRoomId) return activeRoomId;

    // otherwise: pick first room from list
    const qRooms = query(collection(db,"rooms"), where("members","array-contains", me.uid), orderBy("updatedAt","desc"), limit(1));
    const snap = await getDocs(qRooms);
    if(snap.empty) return null;
    return snap.docs[0].id;
  }

  btnSendSnap.onclick = async () => {
    if(!me) return;
    if(!lastSnapBlob) { alert("Take a snap first (shutter)"); return; }

    const roomId = await pickRoomToSend();
    if(!roomId) { alert("No chats yet. Add a friend and get them to add back."); return; }

    try{
      const url = await uploadSnap(lastSnapBlob);

      await addDoc(collection(db,"rooms",roomId,"messages"), {
        type:"snap",
        mediaURL: url,
        uid: me.uid,
        email: me.email,
        fromName: meProfile?.displayName || meProfile?.username || "",
        createdAt: serverTimestamp()
      });

      await setDoc(doc(db,"rooms",roomId), {
        lastPreview: "Snap",
        updatedAt: serverTimestamp()
      }, {merge:true});

      // streak update is SNAP-ONLY
      await updateSnapStreak(roomId, me.uid);

      lastSnapBlob = null;
      alert("Snap sent");
    } catch(e){
      alert(e.message);
    }
  };

  // ---------- FRIEND REQUEST LISTENERS (badge + lists) ----------
  function renderEmpty(el, txt){
    el.innerHTML = `<div style="padding:12px;color:#888">${txt}</div>`;
  }

  function setBadge(n){
    if(n>0){
      addBadge.textContent = String(n);
      addBadge.classList.remove("hidden");
    } else {
      addBadge.classList.add("hidden");
    }
  }

  function listenRequests(){
    // people who added you (pending)
    const qIn = query(collection(db,"friendRequests"), where("to","==", me.uid), where("status","==","pending"));
    onSnapshot(qIn, (snap)=>{
      setBadge(snap.size);
      requestsList.innerHTML = "";
      if(snap.empty){ renderEmpty(requestsList, "No new adds"); return; }

      snap.forEach(docu=>{
        const r = docu.data();
        const li = document.createElement("div");
        li.className = "li";
        li.innerHTML = `
          <div class="left">
            <div class="t">@${r.fromUsername || "unknown"}</div>
            <div class="d">Added you</div>
          </div>
          <div style="display:flex;gap:8px">
            <button class="snap">Accept</button>
            <button>Decline</button>
          </div>
        `;
        const [acceptBtn, declineBtn] = li.querySelectorAll("button");
        acceptBtn.onclick = async ()=>{ await acceptRequest({id: docu.id, ...r}); };
        declineBtn.onclick = async ()=>{ await declineRequest({id: docu.id, ...r}); };
        requestsList.appendChild(li);
      });
    });

    // recently added list (outgoing)
    const qRecent = query(collection(db,"recentlyAdded"), where("owner","==", me.uid), orderBy("createdAt","desc"), limit(30));
    onSnapshot(qRecent, (snap)=>{
      recentList.innerHTML = "";
      if(snap.empty){ renderEmpty(recentList, "No recently added"); return; }
      snap.forEach(d=>{
        const x = d.data();
        const li = document.createElement("div");
        li.className = "li";
        li.innerHTML = `
          <div class="left">
            <div class="t">@${x.otherUsername || "user"}</div>
            <div class="d">Requested</div>
          </div>
          <div><button>OK</button></div>
        `;
        li.querySelector("button").onclick = ()=>{};
        recentList.appendChild(li);
      });
    });
  }

  // ---------- CHAT LIST (only accepted friends / rooms show) ----------
  const userCache = new Map();

  async function getUser(uid){
    if(userCache.has(uid)) return userCache.get(uid);
    const s = await getDoc(doc(db,"users", uid));
    const data = s.exists() ? s.data() : {uid, username:"user", displayName:"user", photoURL:""};
    userCache.set(uid, data);
    return data;
  }

  async function buildRoomTitle(room){
    if(room.type === "group") return room.name || "Group";
    // dm: show other person's displayName/username, with local nickname override handled in openRoom
    const other = room.members.find(u=>u !== me.uid);
    const u = await getUser(other);
    return u.displayName || u.username || "Chat";
  }

  async function buildRoomAvatar(room){
    if(room.type === "group") return {letter:"G", url:""};
    const other = room.members.find(u=>u !== me.uid);
    const u = await getUser(other);
    const url = u.photoURL || "";
    const letter = (u.displayName || u.username || "C")[0].toUpperCase();
    return {letter, url};
  }

  function listenRooms(){
    // only rooms where you are a member
    const qRooms = query(collection(db,"rooms"), where("members","array-contains", me.uid), orderBy("updatedAt","desc"), limit(50));
    onSnapshot(qRooms, async (snap)=>{
      chatList.innerHTML = "";
      if(snap.empty){
        chatList.innerHTML = `<div style="padding:18px;color:#888">No chats yet. Add a friend and get them to add you back.</div>`;
        return;
      }

      for(const docu of snap.docs){
        const room = { id: docu.id, ...docu.data() };

        // enforce ‚Äúdon‚Äôt show until added back‚Äù: only rooms are created on accept, so good
        const title = await buildRoomTitle(room);
        const av = await buildRoomAvatar(room);
        const streak = room.streakCount || 0;
        const subtitle = (streak>0 ? `üî• ${streak} ` : "") + (room.lastPreview || "Tap to open");

        const row = document.createElement("div");
        row.className = "row";
        row.innerHTML = `
          <div class="who">
            <div class="avatar">${av.url ? `<img src="${av.url}" />` : av.letter}</div>
            <div class="meta">
              <div class="name"></div>
              <div class="sub"></div>
            </div>
          </div>
          <div class="rightIcons">
            <div class="tiny">üìå</div>
            <div class="tiny">üì∑</div>
            <div class="tiny">‚Ü©Ô∏è</div>
          </div>
        `;
        row.querySelector(".name").textContent = title;
        row.querySelector(".sub").textContent = subtitle;

        row.onclick = async ()=>{
          // open room + apply nickname + wallpaper
          openRoom(room.id, { ...room, title });
          const wall = localStorage.getItem(wallKey(room.id));
          msgs.style.backgroundImage = wall ? `url('${wall}')` : "";
          const nick = localStorage.getItem(nickKey(room.id)) || "";
          chatTitle.textContent = nick || title;
        };

        chatList.appendChild(row);
      }
    });
  }

  // ---------- SHEET CLOSES ----------
  $("btnCloseAdd").onclick = ()=> addSheet.classList.remove("on");
  $("btnCloseProfile").onclick = ()=> profileSheet.classList.remove("on");

  // ---------- ON AUTH STATE ----------
  onAuthStateChanged(auth, async (u) => {
    if(u){
      me = u;
      authScreen.classList.add("hidden");
      mainApp.classList.remove("hidden");

      // load my profile
      const s = await getDoc(doc(db,"users", me.uid));
      meProfile = s.exists() ? s.data() : null;

      // set pill
      if(meProfile?.photoURL){
        mePill.innerHTML = `<img src="${meProfile.photoURL}" />`;
      } else {
        const letter = (meProfile?.displayName || me.email || "I")[0].toUpperCase();
        mePill.textContent = letter;
      }

      // profile fields
      displayName.value = meProfile?.displayName || "";
      profileMsg.textContent = isAdmin() ? "Admin enabled" : "";

      // start camera + start on cam
      setScreen(1);
      await startCamera();

      // listeners
      listenRequests();
      listenRooms();

    } else {
      // logout
      me = null;
      meProfile = null;
      closeChat();
      mainApp.classList.add("hidden");
      authScreen.classList.remove("hidden");
      await stopCamera();
    }
  });

</script>
</body>
</html>

